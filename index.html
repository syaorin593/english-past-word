<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è‹±èªéå»å½¢ã‚¯ã‚¨ã‚¹ãƒˆ - å®Œå…¨ç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Dela+Gothic+One&family=M+PLUS+Rounded+1c:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'M PLUS Rounded 1c', sans-serif; touch-action: manipulation; }
        .title-font { font-family: 'Dela Gothic One', cursive; }
        .star-bg { background: linear-gradient(135deg, #0f172a 0%, #312e81 50%, #1e1b4b 100%); }
        .game-card { background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%); box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.3); }
        .choice-btn { transition: all 0.1s cubic-bezier(0.4, 0, 0.2, 1); touch-action: manipulation; }
        .choice-btn:active { transform: translateY(2px); border-bottom-width: 0px; margin-top: 4px; }
        
        /* å›³é‘‘ç”¨ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .zukan-item { transition: all 0.3s ease; }
        .zukan-locked { background-color: rgba(0,0,0,0.3); color: rgba(255,255,255,0.2); border: 2px dashed rgba(255,255,255,0.1); }
        .zukan-unlocked { background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; transform: scale(1); border: 2px solid #34d399; }
        .zukan-new { animation: pulse-glow 2s infinite; }

        @keyframes pulse-glow {
            0% { box-shadow: 0 0 0 0 rgba(52, 211, 153, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(52, 211, 153, 0); }
            100% { box-shadow: 0 0 0 0 rgba(52, 211, 153, 0); }
        }

        @keyframes pop { 0% { transform: scale(0.8); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
        .animate-pop { animation: pop 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .hidden { display: none !important; }
    </style>
</head>
<body class="h-full star-bg overflow-auto text-white selection:bg-purple-500 selection:text-white min-h-screen">

    <div id="app" class="min-h-screen w-full max-w-2xl mx-auto p-4 flex flex-col items-center justify-center">

        <div id="screen-start" class="w-full text-center animate-pop">
            <div class="text-7xl mb-4 drop-shadow-lg">ğŸ°</div>
            <h1 class="title-font text-4xl md:text-5xl mb-2 text-transparent bg-clip-text bg-gradient-to-r from-yellow-200 to-yellow-500 drop-shadow-sm leading-tight pb-2">
                è‹±èªéå»å½¢<br>ã‚¯ã‚¨ã‚¹ãƒˆ
            </h1>
            <p class="text-indigo-200 text-sm mb-6 font-bold">New Horizon 1å¹´å¯¾å¿œç‰ˆ</p>
            
            <div class="bg-white/10 backdrop-blur-md rounded-3xl p-6 mb-6 border border-white/10">
                <h2 class="text-indigo-200 font-bold mb-4">å‡ºé¡Œãƒ¢ãƒ¼ãƒ‰ã‚’é¸æŠ</h2>
                <div class="space-y-3">
                    <button onclick="selectMode('choice')" class="w-full py-4 bg-gradient-to-r from-cyan-500 to-blue-600 font-bold rounded-2xl choice-btn text-xl shadow-lg border-b-4 border-blue-800">
                        ğŸ¯ 4æŠãƒ¢ãƒ¼ãƒ‰
                    </button>
                    <button onclick="selectMode('writing')" class="w-full py-4 bg-gradient-to-r from-purple-500 to-indigo-600 font-bold rounded-2xl choice-btn text-xl shadow-lg border-b-4 border-indigo-800">
                        âœï¸ ãƒ©ã‚¤ãƒ†ã‚£ãƒ³ã‚°
                    </button>
                    <button onclick="selectMode('mix')" class="w-full py-4 bg-gradient-to-r from-pink-500 to-rose-600 font-bold rounded-2xl choice-btn text-xl shadow-lg border-b-4 border-rose-800">
                        ğŸ”¥ ãƒŸãƒƒã‚¯ã‚¹
                    </button>
                </div>
            </div>

            <div class="flex justify-center gap-4">
                <button onclick="showRanking()" class="text-yellow-300 font-bold hover:underline py-2">ğŸ† ãƒ©ãƒ³ã‚­ãƒ³ã‚°</button>
                <button onclick="openZukan()" class="text-emerald-300 font-bold hover:underline py-2">ğŸ“– å˜èªå›³é‘‘</button>
            </div>
        </div>

        <div id="screen-difficulty" class="w-full max-w-md text-center hidden animate-pop">
            <h2 class="title-font text-3xl mb-6">é›£æ˜“åº¦ã‚’é¸ã¹ï¼</h2>
            <div class="space-y-4">
                <button onclick="startGame('easy')" class="w-full py-4 bg-emerald-500 hover:bg-emerald-400 font-bold rounded-2xl choice-btn border-b-4 border-emerald-700 text-lg">
                    ğŸŒ± åˆç´š (åŸºæœ¬30ç‚¹)
                </button>
                <button onclick="startGame('normal')" class="w-full py-4 bg-amber-500 hover:bg-amber-400 font-bold rounded-2xl choice-btn border-b-4 border-amber-700 text-lg">
                    âš”ï¸ ä¸­ç´š (åŸºæœ¬40ç‚¹)
                </button>
                <button onclick="startGame('hard')" class="w-full py-4 bg-red-600 hover:bg-red-500 font-bold rounded-2xl choice-btn border-b-4 border-red-800 text-lg">
                    ğŸ’€ ä¸Šç´š (åŸºæœ¬50ç‚¹)
                </button>
            </div>
            <button onclick="backToStart()" class="mt-8 text-indigo-200 hover:text-white py-2">â†© æˆ»ã‚‹</button>
        </div>

        <div id="screen-zukan" class="w-full hidden animate-pop">
            <div class="flex justify-between items-center mb-4">
                <h2 class="title-font text-2xl text-emerald-300">ğŸ“– é­”å°æ›¸ (å˜èªå›³é‘‘)</h2>
                <div class="text-right">
                    <span class="text-xs text-indigo-200 block">åé›†ç‡</span>
                    <span id="collection-rate" class="text-2xl font-bold">0%</span>
                </div>
            </div>
            <div id="zukan-grid" class="grid grid-cols-2 md:grid-cols-3 gap-3 mb-6 overflow-y-auto max-h-[60vh] p-2 bg-black/20 rounded-xl">
                </div>
            <button onclick="backToStart()" class="w-full py-3 bg-white/20 font-bold rounded-xl hover:bg-white/30">â†© ã‚¿ã‚¤ãƒˆãƒ«ã¸æˆ»ã‚‹</button>
        </div>

        <div id="screen-game" class="w-full max-w-md hidden">
            <div class="flex justify-between items-end mb-6 bg-slate-900/50 p-4 rounded-2xl border border-white/10 backdrop-blur-sm">
                <div>
                    <p class="text-xs text-indigo-300 mb-1">COMBO</p>
                    <div id="combo-display" class="text-xl font-bold text-orange-400 h-6"></div>
                </div>
                <div class="text-right">
                    <p class="text-xs text-indigo-300 mb-1">SCORE</p>
                    <p id="score-display" class="title-font text-3xl text-yellow-300">0</p>
                </div>
            </div>

            <div id="question-card" class="game-card rounded-3xl p-8 mb-6 text-center relative overflow-hidden border-b-8 border-indigo-700">
                <span id="q-difficulty" class="text-xs font-bold bg-black/30 px-3 py-1 rounded-full mb-4 inline-block uppercase">Question 1</span>
                <h2 id="verb-base" class="title-font text-5xl mb-3 drop-shadow-md break-words">play</h2>
                <p id="verb-meaning" class="text-white/80 text-lg font-bold">ï¼ˆã€œã‚’ã™ã‚‹ï¼‰</p>
            </div>

            <div id="choices-container" class="grid grid-cols-1 sm:grid-cols-2 gap-4 hidden"></div>

            <div id="writing-container" class="hidden">
                <input type="text" id="answer-input" class="w-full p-4 rounded-xl bg-white text-slate-800 text-center text-2xl font-bold outline-none ring-4 ring-transparent focus:ring-yellow-400 mb-4" placeholder="éå»å½¢ã‚’å…¥åŠ›" autocomplete="off" autocapitalize="off">
                <button onclick="checkWritingAnswer()" class="w-full py-4 bg-indigo-500 text-white font-bold rounded-xl shadow-lg border-b-4 border-indigo-700 active:border-b-0 active:mt-1">æ±ºå®š</button>
            </div>
        </div>

        <div id="screen-feedback" class="fixed inset-0 flex items-center justify-center bg-black/80 z-50 hidden backdrop-blur-sm px-4">
            <div class="text-center w-full max-w-sm p-6 animate-pop">
                <div id="fb-icon" class="text-8xl mb-4 filter drop-shadow-lg">âœ¨</div>
                <h2 id="fb-text" class="title-font text-4xl text-white mb-2">Great!</h2>
                
                <div id="zukan-badge" class="hidden inline-block bg-emerald-500 text-white font-bold px-4 py-1 rounded-full text-sm mb-2 animate-bounce">ğŸ“– å›³é‘‘ç™»éŒ²ï¼</div>
                
                <p id="fb-score-detail" class="text-yellow-300 font-bold mb-4"></p>

                <div id="fb-correct-box" class="hidden bg-red-500/20 border-2 border-red-500 rounded-xl p-4 mb-6">
                    <p class="text-xs text-red-200 uppercase mb-1">æ­£è§£ã¯...</p>
                    <p id="fb-correct-word" class="text-3xl font-bold text-white">played</p>
                </div>

                <button id="next-btn" onclick="nextQuestion()" class="w-full py-4 bg-white text-indigo-900 font-bold rounded-2xl text-xl shadow-lg border-b-4 border-gray-300 active:border-b-0 active:translate-y-1">æ¬¡ã¸ (Enter)</button>
            </div>
        </div>

        <div id="screen-result" class="w-full max-w-md text-center hidden animate-pop">
            <div class="mb-4 relative inline-block">
                <div class="text-8xl">ğŸ†</div>
                <div id="result-rank-badge" class="absolute -bottom-2 -right-2 bg-yellow-400 text-black font-bold rounded-full w-12 h-12 flex items-center justify-center border-4 border-white text-xl shadow-lg">S</div>
            </div>
            
            <h2 class="title-font text-2xl mb-1 text-white">ã‚¯ã‚¨ã‚¹ãƒˆå®Œäº†ï¼</h2>
            <p id="result-title" class="text-yellow-300 text-xl font-bold mb-6">ç§°å·ï¼šæ™‚ç©ºã®è¦‡è€…</p>
            
            <div class="bg-white/10 backdrop-blur-md rounded-2xl p-6 mb-6 border border-white/10">
                <p class="text-xs text-indigo-200">ä»Šå›ã®ã‚¹ã‚³ã‚¢</p>
                <p id="final-score" class="text-5xl font-bold text-yellow-300">0</p>
                <div class="flex justify-between mt-2 text-sm text-indigo-200">
                    <span id="final-combo">Max Combo: 0</span>
                    <span id="final-new-words" class="text-emerald-400">å›³é‘‘: +0</span>
                </div>
            </div>

            <div class="flex gap-2 mb-6">
                <input type="text" id="player-name" placeholder="åå‰ã‚’å…¥åŠ›" class="flex-1 p-3 rounded-xl text-black">
                <button onclick="saveScore()" class="bg-green-500 px-4 rounded-xl font-bold shadow-lg border-b-4 border-green-700 active:border-b-0 active:translate-y-1">ä¿å­˜</button>
            </div>

            <div class="space-y-3">
                <button onclick="shareResult()" class="w-full py-3 bg-blue-500 font-bold rounded-xl border-b-4 border-blue-700 active:border-b-0 active:translate-y-1">ğŸ“‹ çµæœã‚’ã‚³ãƒ”ãƒ¼</button>
                <button onclick="backToStart()" class="w-full py-3 bg-white/20 font-bold rounded-xl active:bg-white/30">ğŸ  ã‚¿ã‚¤ãƒˆãƒ«ã¸</button>
            </div>

            <div class="mt-8 text-left bg-black/20 p-4 rounded-xl">
                <h3 class="text-yellow-300 font-bold mb-2 border-b border-white/20 pb-1">ğŸ… ãƒ­ãƒ¼ã‚«ãƒ«ãƒ©ãƒ³ã‚­ãƒ³ã‚°</h3>
                <div id="ranking-list" class="space-y-2 text-sm"></div>
            </div>
        </div>

    </div>

    <script>
        /* =========================================
           å˜èªãƒ‡ãƒ¼ã‚¿ (IDä»˜ã)
           ========================================= */
        const verbsData = [
            { id: 'play', base: 'play', past: 'played', meaning: 'éŠã¶' },
            { id: 'watch', base: 'watch', past: 'watched', meaning: 'è¦‹ã‚‹' },
            { id: 'cook', base: 'cook', past: 'cooked', meaning: 'æ–™ç†ã™ã‚‹' },
            { id: 'study', base: 'study', past: 'studied', meaning: 'å‹‰å¼·ã™ã‚‹' },
            { id: 'use', base: 'use', past: 'used', meaning: 'ä½¿ã†' },
            { id: 'visit', base: 'visit', past: 'visited', meaning: 'è¨ªã‚Œã‚‹' },
            { id: 'stop', base: 'stop', past: 'stopped', meaning: 'æ­¢ã¾ã‚‹' },
            { id: 'listen', base: 'listen', past: 'listened', meaning: 'èã' },
            { id: 'go', base: 'go', past: 'went', meaning: 'è¡Œã' },
            { id: 'see', base: 'see', past: 'saw', meaning: 'è¦‹ã‚‹ãƒ»ä¼šã†' },
            { id: 'eat', base: 'eat', past: 'ate', meaning: 'é£Ÿã¹ã‚‹' },
            { id: 'have', base: 'have', past: 'had', meaning: 'æŒã¤' },
            { id: 'buy', base: 'buy', past: 'bought', meaning: 'è²·ã†' },
            { id: 'make', base: 'make', past: 'made', meaning: 'ä½œã‚‹' },
            { id: 'come', base: 'come', past: 'came', meaning: 'æ¥ã‚‹' },
            { id: 'write', base: 'write', past: 'wrote', meaning: 'æ›¸ã' },
            { id: 'read', base: 'read', past: 'read', meaning: 'èª­ã‚€' },
            { id: 'run', base: 'run', past: 'ran', meaning: 'èµ°ã‚‹' },
            { id: 'swim', base: 'swim', past: 'swam', meaning: 'æ³³ã' },
            { id: 'know', base: 'know', past: 'knew', meaning: 'çŸ¥ã£ã¦ã„ã‚‹' },
            { id: 'say', base: 'say', past: 'said', meaning: 'è¨€ã†' },
            { id: 'get', base: 'get', past: 'got', meaning: 'å¾—ã‚‹' },
            { id: 'take', base: 'take', past: 'took', meaning: 'å–ã‚‹' }
        ];

        /* =========================================
           ã‚²ãƒ¼ãƒ çŠ¶æ…‹ç®¡ç†
           ========================================= */
        let gameState = {
            mode: 'choice',
            difficulty: 'normal',
            questions: [],
            currentQIndex: 0,
            score: 0,
            combo: 0,
            maxCombo: 0,
            newWordsCount: 0
        };

        // å›³é‘‘ãƒ‡ãƒ¼ã‚¿ (ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‹ã‚‰èª­ã¿è¾¼ã¿)
        let collection = JSON.parse(localStorage.getItem('english_past_collection')) || [];

        /* =========================================
           å›³é‘‘ã‚·ã‚¹ãƒ†ãƒ 
           ========================================= */
        function saveCollection() {
            localStorage.setItem('english_past_collection', JSON.stringify(collection));
        }

        function unlockWord(wordId) {
            if (!collection.includes(wordId)) {
                collection.push(wordId);
                saveCollection();
                gameState.newWordsCount++;
                return true; // æ–°è¦ç™»éŒ²
            }
            return false;
        }

        function openZukan() {
            switchScreen('screen-zukan');
            const grid = document.getElementById('zukan-grid');
            grid.innerHTML = '';
            
            verbsData.forEach(verb => {
                const isUnlocked = collection.includes(verb.id);
                const el = document.createElement('div');
                
                if (isUnlocked) {
                    el.className = 'zukan-item zukan-unlocked rounded-xl p-2 shadow-md text-center';
                    el.innerHTML = `
                        <div class="text-xs opacity-80 mb-1">${verb.meaning}</div>
                        <div class="font-bold">${verb.base}</div>
                        <div class="text-yellow-200 font-bold text-sm">â¡ ${verb.past}</div>
                    `;
                } else {
                    el.className = 'zukan-item zukan-locked rounded-xl p-2 text-center flex flex-col justify-center items-center';
                    el.innerHTML = `<div class="text-xl">ğŸ”’</div><div class="text-xs font-bold mt-1">???</div>`;
                }
                grid.appendChild(el);
            });

            // åé›†ç‡
            const rate = Math.floor((collection.length / verbsData.length) * 100);
            document.getElementById('collection-rate').textContent = `${rate}%`;
        }

        /* =========================================
           ç”»é¢é·ç§»
           ========================================= */
        function switchScreen(screenId) {
            const screens = ['screen-start', 'screen-difficulty', 'screen-game', 'screen-feedback', 'screen-result', 'screen-zukan'];
            screens.forEach(id => {
                const el = document.getElementById(id);
                if (id === screenId) el.classList.remove('hidden');
                else el.classList.add('hidden');
            });
        }

        function backToStart() { switchScreen('screen-start'); }
        function selectMode(mode) { gameState.mode = mode; switchScreen('screen-difficulty'); }

        /* =========================================
           ã‚²ãƒ¼ãƒ ãƒ­ã‚¸ãƒƒã‚¯
           ========================================= */
        function startGame(difficulty) {
            gameState.difficulty = difficulty;
            gameState.score = 0;
            gameState.combo = 0;
            gameState.maxCombo = 0;
            gameState.currentQIndex = 0;
            gameState.newWordsCount = 0;
            
            gameState.questions = [...verbsData].sort(() => Math.random() - 0.5).slice(0, 10);
            switchScreen('screen-game');
            showQuestion();
        }

        function showQuestion() {
            const q = gameState.questions[gameState.currentQIndex];
            
            let isWriting = false;
            if (gameState.mode === 'writing') isWriting = true;
            else if (gameState.mode === 'mix') isWriting = Math.random() < 0.5;

            document.getElementById('verb-base').textContent = q.base;
            document.getElementById('verb-meaning').textContent = `ï¼ˆ${q.meaning}ï¼‰`;
            document.getElementById('q-difficulty').textContent = `${gameState.currentQIndex + 1}/10å•ç›®`;
            document.getElementById('score-display').textContent = gameState.score;
            document.getElementById('combo-display').textContent = gameState.combo > 1 ? `${gameState.combo} COMBO! ğŸ”¥` : '';

            const input = document.getElementById('answer-input');
            input.value = '';
            const choicesDiv = document.getElementById('choices-container');
            const writingDiv = document.getElementById('writing-container');

            if (isWriting) {
                choicesDiv.classList.add('hidden');
                writingDiv.classList.remove('hidden');
                setTimeout(() => input.focus(), 100);
            } else {
                writingDiv.classList.add('hidden');
                choicesDiv.classList.remove('hidden');
                generateChoices(q, gameState.difficulty);
            }
        }

        function generateChoices(q, difficulty) {
            const container = document.getElementById('choices-container');
            container.innerHTML = '';
            let choices = [q.past];

            if (difficulty === 'easy') {
                const others = verbsData.filter(v => v.base !== q.base).map(v => v.past);
                choices.push(...others.sort(() => Math.random() - 0.5).slice(0, 3));
            } else {
                const distractors = generateTrickyDistractors(q);
                choices.push(...distractors.slice(0, 3));
            }

            choices.sort(() => Math.random() - 0.5);

            choices.forEach(choice => {
                const btn = document.createElement('button');
                btn.className = "choice-btn w-full py-4 bg-white/90 hover:bg-white text-indigo-900 text-xl font-bold rounded-xl shadow-lg border-b-4 border-indigo-200 active:border-b-0 active:translate-y-1";
                btn.textContent = choice;
                btn.onclick = () => checkAnswer(choice, false);
                container.appendChild(btn);
            });
        }

        function generateTrickyDistractors(q) {
            let fakes = [];
            const base = q.base;
            fakes.push(base + 'ed');
            if (!base.endsWith('e')) fakes.push(base + 'd');
            if (base.endsWith('y')) fakes.push(base + 'ed');
            fakes.push(base + 'ing');
            if (base.match(/[aeiou][b-df-hj-np-tv-z]$/)) fakes.push(base + 'ed'); 
            const others = verbsData.filter(v => v.base !== base).map(v => v.past);
            fakes.push(...others);
            return [...new Set(fakes)].filter(f => f !== q.past).sort(() => Math.random() - 0.5);
        }

        function checkWritingAnswer() {
            const input = document.getElementById('answer-input');
            checkAnswer(input.value.trim().toLowerCase(), true);
        }

        function checkAnswer(userAnswer, isWritingInput) {
            const q = gameState.questions[gameState.currentQIndex];
            const isCorrect = (userAnswer === q.past);
            let newUnlocked = false;

            if (isCorrect) {
                gameState.combo++;
                if (gameState.combo > gameState.maxCombo) gameState.maxCombo = gameState.combo;

                let basePoint = 30; // easy
                if (gameState.difficulty === 'normal') basePoint = 40;
                else if (gameState.difficulty === 'hard') basePoint = 50;

                if (isWritingInput) basePoint += 20;

                let multiplier = 1.0;
                if (gameState.combo >= 8) multiplier = 2.5;
                else if (gameState.combo >= 5) multiplier = 2.0;
                else if (gameState.combo >= 3) multiplier = 1.5;

                const points = Math.floor(basePoint * multiplier);
                gameState.score += points;
                
                // å›³é‘‘ç™»éŒ²
                if (unlockWord(q.id)) {
                    newUnlocked = true;
                }

                showFeedback(true, q.past, points, multiplier, newUnlocked);
            } else {
                gameState.combo = 0;
                showFeedback(false, q.past, 0, 1, false);
            }
        }

        function showFeedback(isCorrect, correctAnswer, points, multiplier, newUnlocked) {
            document.getElementById('screen-feedback').classList.remove('hidden');
            const icon = document.getElementById('fb-icon');
            const text = document.getElementById('fb-text');
            const detail = document.getElementById('fb-score-detail');
            const correctBox = document.getElementById('fb-correct-box');
            const zukanBadge = document.getElementById('zukan-badge');

            if (isCorrect) {
                icon.textContent = 'âš”ï¸';
                text.textContent = 'Nice!';
                text.className = "title-font text-4xl text-yellow-300 mb-2";
                
                let msg = `+${points} pts`;
                if (multiplier > 1) msg += ` (x${multiplier} Combo!)`;
                detail.textContent = msg;
                correctBox.classList.add('hidden');
                
                if (newUnlocked) zukanBadge.classList.remove('hidden');
                else zukanBadge.classList.add('hidden');

            } else {
                icon.textContent = 'ğŸ’¥';
                text.textContent = 'Miss...';
                text.className = "title-font text-4xl text-rose-300 mb-2";
                detail.textContent = '';
                correctBox.classList.remove('hidden');
                document.getElementById('fb-correct-word').textContent = correctAnswer;
                zukanBadge.classList.add('hidden');
            }

            setTimeout(() => document.getElementById('next-btn').focus(), 50);
        }

        function nextQuestion() {
            document.getElementById('screen-feedback').classList.add('hidden');
            gameState.currentQIndex++;
            if (gameState.currentQIndex >= 10) endGame();
            else showQuestion();
        }

        /* =========================================
           çµæœç”»é¢ãƒ»ç§°å·
           ========================================= */
        function endGame() {
            switchScreen('screen-result');
            document.getElementById('final-score').textContent = gameState.score;
            document.getElementById('final-combo').textContent = `Max Combo: ${gameState.maxCombo}`;
            document.getElementById('final-new-words').textContent = `å›³é‘‘ç™»éŒ²: +${gameState.newWordsCount}`;
            
            // ç§°å·åˆ¤å®š
            const rankBadge = document.getElementById('result-rank-badge');
            const titleEl = document.getElementById('result-title');
            
            let rank = 'C';
            let title = 'è¦‹ç¿’ã„å†’é™ºè€…';
            let color = 'bg-gray-500';

            // ã‚¹ã‚³ã‚¢åŸºæº–ï¼ˆãƒ¢ãƒ¼ãƒ‰ã‚„é›£æ˜“åº¦ã§å¤‰å‹•ã™ã‚‹ãŒç›®å®‰ã¨ã—ã¦ï¼‰
            if (gameState.score >= 800) { rank = 'S'; title = 'æ™‚ç©ºã®è¦‡è€…'; color = 'bg-yellow-400'; }
            else if (gameState.score >= 500) { rank = 'A'; title = 'éå»å½¢ãƒã‚¹ã‚¿ãƒ¼'; color = 'bg-rose-500'; }
            else if (gameState.score >= 300) { rank = 'B'; title = 'ãƒ™ãƒ†ãƒ©ãƒ³æˆ¦å£«'; color = 'bg-blue-500'; }

            rankBadge.textContent = rank;
            rankBadge.className = `absolute -bottom-2 -right-2 ${color} text-white font-bold rounded-full w-12 h-12 flex items-center justify-center border-4 border-white text-xl shadow-lg`;
            titleEl.textContent = `ç§°å·ï¼š${title}`;

            loadRanking();
        }

        /* =========================================
           ãƒ©ãƒ³ã‚­ãƒ³ã‚° & å…±æœ‰
           ========================================= */
        const STORAGE_KEY = 'past_tense_ranking_full';

        function loadRanking() {
            const list = document.getElementById('ranking-list');
            const data = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
            data.sort((a, b) => b.score - a.score);

            if (data.length === 0) {
                list.innerHTML = '<p class="text-white/50 text-center">ã¾ã è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“</p>';
                return;
            }

            list.innerHTML = data.slice(0, 5).map((r, i) => {
                const medal = ['ğŸ¥‡','ğŸ¥ˆ','ğŸ¥‰'][i] || `${i+1}ä½`;
                return `
                    <div class="flex justify-between bg-white/10 p-2 rounded mb-1 items-center">
                        <span class="truncate max-w-[150px]">${medal} ${r.name}</span>
                        <div class="text-right">
                            <span class="font-bold text-yellow-300 block">${r.score}</span>
                            <span class="text-xs text-white/50">${r.title}</span>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function saveScore() {
            const name = document.getElementById('player-name').value.trim() || 'åç„¡ã—';
            const title = document.getElementById('result-title').textContent.replace('ç§°å·ï¼š', '');
            
            const data = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
            data.push({ name: name, score: gameState.score, title: title, date: new Date().toISOString() });
            localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
            alert('ä¿å­˜ã—ã¾ã—ãŸï¼');
            loadRanking();
        }

        function showRanking() {
            switchScreen('screen-result');
            document.getElementById('final-score').textContent = '-';
            document.getElementById('result-rank-badge').classList.add('hidden');
            loadRanking();
        }

        function shareResult() {
            const title = document.getElementById('result-title').textContent;
            const text = `è‹±èªéå»å½¢ã‚¯ã‚¨ã‚¹ãƒˆã§ ${gameState.score}ç‚¹ï¼\n${title} ã‚’ç²å¾—ï¼\n#è‹±èªå­¦ç¿’`;
            navigator.clipboard.writeText(text).then(() => alert('ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼'));
        }

        document.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                if (!document.getElementById('screen-feedback').classList.contains('hidden')) {
                    nextQuestion();
                    return;
                }
                if (!document.getElementById('screen-game').classList.contains('hidden') && 
                    !document.getElementById('writing-container').classList.contains('hidden')) {
                    checkWritingAnswer();
                }
            }
        });
    </script>
</body>
</html>
