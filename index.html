<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è‹±èªéå»å½¢ã‚¯ã‚¨ã‚¹ãƒˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Dela+Gothic+One&family=M+PLUS+Rounded+1c:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        /* CSSã‚¹ã‚¿ã‚¤ãƒ«è¨­å®š */
        body {
            font-family: 'M PLUS Rounded 1c', sans-serif;
            touch-action: manipulation; /* ã‚¹ãƒãƒ›ã§ã®ã‚¿ãƒƒãƒ—é…å»¶é˜²æ­¢ */
        }
        .title-font {
            font-family: 'Dela Gothic One', cursive;
        }

        /* èƒŒæ™¯è¨­å®š */
        .star-bg {
            background: linear-gradient(135deg, #0f172a 0%, #312e81 50%, #1e1b4b 100%);
        }

        /* ã‚«ãƒ¼ãƒ‰ã¨ãƒœã‚¿ãƒ³ã®ãƒ‡ã‚¶ã‚¤ãƒ³ */
        .game-card {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.3);
        }

        .choice-btn {
            transition: all 0.1s cubic-bezier(0.4, 0, 0.2, 1);
            touch-action: manipulation;
        }
        .choice-btn:active {
            transform: translateY(2px);
            border-bottom-width: 0px;
            margin-top: 4px; /* ä½ç½®èª¿æ•´ */
        }

        /* ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³å®šç¾© */
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-8px); }
            75% { transform: translateX(8px); }
        }
        .animate-shake {
            animation: shake 0.3s ease-in-out;
        }

        @keyframes pop {
            0% { transform: scale(0.8); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }
        .animate-pop {
            animation: pop 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        /* Tailwindèª­ã¿è¾¼ã¿å‰ã®ã¡ã‚‰ã¤ãé˜²æ­¢ */
        .hidden { display: none !important; }
    </style>
</head>
<body class="h-full star-bg overflow-auto text-white selection:bg-purple-500 selection:text-white min-h-screen">

    <div id="app" class="min-h-screen w-full max-w-2xl mx-auto p-4 flex flex-col items-center justify-center">

        <div id="screen-start" class="w-full text-center animate-pop">
            <div class="text-7xl mb-4 drop-shadow-lg">ğŸ°</div>
            <h1 class="title-font text-4xl md:text-5xl mb-6 text-transparent bg-clip-text bg-gradient-to-r from-yellow-200 to-yellow-500 drop-shadow-sm leading-tight pb-2">
                è‹±èªéå»å½¢<br>ã‚¯ã‚¨ã‚¹ãƒˆ
            </h1>
            
            <div class="bg-white/10 backdrop-blur-md rounded-3xl p-6 mb-8 border border-white/10">
                <h2 class="text-indigo-200 font-bold mb-4">å‡ºé¡Œãƒ¢ãƒ¼ãƒ‰ã‚’é¸æŠ</h2>
                <div class="space-y-4">
                    <button onclick="selectMode('choice')" class="w-full py-4 bg-gradient-to-r from-cyan-500 to-blue-600 font-bold rounded-2xl choice-btn text-xl shadow-lg border-b-4 border-blue-800">
                        ğŸ¯ 4æŠãƒ¢ãƒ¼ãƒ‰
                    </button>
                    <button onclick="selectMode('writing')" class="w-full py-4 bg-gradient-to-r from-purple-500 to-indigo-600 font-bold rounded-2xl choice-btn text-xl shadow-lg border-b-4 border-indigo-800">
                        âœï¸ ãƒ©ã‚¤ãƒ†ã‚£ãƒ³ã‚°
                    </button>
                    <button onclick="selectMode('mix')" class="w-full py-4 bg-gradient-to-r from-pink-500 to-rose-600 font-bold rounded-2xl choice-btn text-xl shadow-lg border-b-4 border-rose-800">
                        ğŸ”¥ ãƒŸãƒƒã‚¯ã‚¹
                    </button>
                </div>
            </div>

            <button onclick="showRanking()" class="text-yellow-300 font-bold hover:underline py-2">ğŸ† ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚’è¦‹ã‚‹</button>
        </div>

        <div id="screen-difficulty" class="w-full max-w-md text-center hidden animate-pop">
            <h2 class="title-font text-3xl mb-6">é›£æ˜“åº¦ã‚’é¸ã¹ï¼</h2>
            <div class="space-y-4">
                <button onclick="startGame('easy')" class="w-full py-4 bg-emerald-500 hover:bg-emerald-400 font-bold rounded-2xl choice-btn border-b-4 border-emerald-700 text-lg">
                    ğŸŒ± åˆç´š (åŸºæœ¬ç‚¹ 30)
                </button>
                <button onclick="startGame('normal')" class="w-full py-4 bg-amber-500 hover:bg-amber-400 font-bold rounded-2xl choice-btn border-b-4 border-amber-700 text-lg">
                    âš”ï¸ ä¸­ç´š (åŸºæœ¬ç‚¹ 40)
                </button>
                <button onclick="startGame('hard')" class="w-full py-4 bg-red-600 hover:bg-red-500 font-bold rounded-2xl choice-btn border-b-4 border-red-800 text-lg">
                    ğŸ’€ ä¸Šç´š (åŸºæœ¬ç‚¹ 50)
                </button>
            </div>
            <button onclick="backToStart()" class="mt-8 text-indigo-200 hover:text-white py-2">â†© æˆ»ã‚‹</button>
        </div>

        <div id="screen-game" class="w-full max-w-md hidden">
            <div class="flex justify-between items-end mb-6 bg-slate-900/50 p-4 rounded-2xl border border-white/10 backdrop-blur-sm">
                <div>
                    <p class="text-xs text-indigo-300 mb-1">COMBO</p>
                    <div id="combo-display" class="text-xl font-bold text-orange-400 h-6"></div>
                </div>
                <div class="text-right">
                    <p class="text-xs text-indigo-300 mb-1">SCORE</p>
                    <p id="score-display" class="title-font text-3xl text-yellow-300">0</p>
                </div>
            </div>

            <div id="question-card" class="game-card rounded-3xl p-8 mb-6 text-center relative overflow-hidden border-b-8 border-indigo-700">
                <span id="q-difficulty" class="text-xs font-bold bg-black/30 px-3 py-1 rounded-full mb-4 inline-block uppercase">Question 1</span>
                <h2 id="verb-base" class="title-font text-5xl mb-3 drop-shadow-md break-words">play</h2>
                <p id="verb-meaning" class="text-white/80 text-lg font-bold">ï¼ˆã€œã‚’ã™ã‚‹ï¼‰</p>
            </div>

            <div id="choices-container" class="grid grid-cols-1 sm:grid-cols-2 gap-4 hidden"></div>

            <div id="writing-container" class="hidden">
                <input type="text" id="answer-input" class="w-full p-4 rounded-xl bg-white text-slate-800 text-center text-2xl font-bold outline-none ring-4 ring-transparent focus:ring-yellow-400 mb-4" placeholder="éå»å½¢ã‚’å…¥åŠ›" autocomplete="off" autocapitalize="off">
                <button onclick="checkWritingAnswer()" class="w-full py-4 bg-indigo-500 text-white font-bold rounded-xl shadow-lg border-b-4 border-indigo-700 active:border-b-0 active:mt-1">æ±ºå®š</button>
            </div>
        </div>

        <div id="screen-feedback" class="fixed inset-0 flex items-center justify-center bg-black/80 z-50 hidden backdrop-blur-sm px-4">
            <div class="text-center w-full max-w-sm p-6 animate-pop">
                <div id="fb-icon" class="text-8xl mb-4 filter drop-shadow-lg">âœ¨</div>
                <h2 id="fb-text" class="title-font text-4xl text-white mb-2">Great!</h2>
                <p id="fb-score-detail" class="text-yellow-300 font-bold mb-4"></p>

                <div id="fb-correct-box" class="hidden bg-red-500/20 border-2 border-red-500 rounded-xl p-4 mb-6">
                    <p class="text-xs text-red-200 uppercase mb-1">æ­£è§£ã¯...</p>
                    <p id="fb-correct-word" class="text-3xl font-bold text-white">played</p>
                </div>

                <button id="next-btn" onclick="nextQuestion()" class="w-full py-4 bg-white text-indigo-900 font-bold rounded-2xl text-xl shadow-lg border-b-4 border-gray-300 active:border-b-0 active:translate-y-1">æ¬¡ã¸ (Enter)</button>
            </div>
        </div>

        <div id="screen-result" class="w-full max-w-md text-center hidden animate-pop">
            <div class="text-8xl mb-4">ğŸ†</div>
            <h2 class="title-font text-3xl mb-2 text-white">ã‚¯ã‚¨ã‚¹ãƒˆå®Œäº†ï¼</h2>
            
            <div class="bg-white/10 backdrop-blur-md rounded-2xl p-6 mb-6 border border-white/10">
                <p class="text-xs text-indigo-200">ä»Šå›ã®ã‚¹ã‚³ã‚¢</p>
                <p id="final-score" class="text-5xl font-bold text-yellow-300">0</p>
                <p id="final-combo" class="text-sm text-orange-300 mt-2">æœ€å¤§ã‚³ãƒ³ãƒœ: 0</p>
            </div>

            <div class="flex gap-2 mb-6">
                <input type="text" id="player-name" placeholder="åå‰ã‚’å…¥åŠ›" class="flex-1 p-3 rounded-xl text-black">
                <button onclick="saveScore()" class="bg-green-500 px-4 rounded-xl font-bold shadow-lg border-b-4 border-green-700 active:border-b-0 active:translate-y-1">ä¿å­˜</button>
            </div>

            <div class="space-y-3">
                <button onclick="shareResult()" class="w-full py-3 bg-blue-500 font-bold rounded-xl border-b-4 border-blue-700 active:border-b-0 active:translate-y-1">ğŸ“‹ çµæœã‚’ã‚³ãƒ”ãƒ¼ã—ã¦å…±æœ‰</button>
                <button onclick="backToStart()" class="w-full py-3 bg-white/20 font-bold rounded-xl active:bg-white/30">ğŸ  ã‚¿ã‚¤ãƒˆãƒ«ã¸</button>
            </div>

            <div class="mt-8 text-left bg-black/20 p-4 rounded-xl">
                <h3 class="text-yellow-300 font-bold mb-2 border-b border-white/20 pb-1">ğŸ… ãƒ­ãƒ¼ã‚«ãƒ«ãƒ©ãƒ³ã‚­ãƒ³ã‚°</h3>
                <div id="ranking-list" class="space-y-2 text-sm"></div>
            </div>
        </div>

    </div>

    <script>
        /* =========================================
           JavaScriptãƒ­ã‚¸ãƒƒã‚¯
           ========================================= */
        
        // å˜èªãƒ‡ãƒ¼ã‚¿
        const verbsData = [
            { base: 'play', past: 'played', meaning: 'éŠã¶' },
            { base: 'watch', past: 'watched', meaning: 'è¦‹ã‚‹' },
            { base: 'cook', past: 'cooked', meaning: 'æ–™ç†ã™ã‚‹' },
            { base: 'study', past: 'studied', meaning: 'å‹‰å¼·ã™ã‚‹' },
            { base: 'use', past: 'used', meaning: 'ä½¿ã†' },
            { base: 'visit', past: 'visited', meaning: 'è¨ªã‚Œã‚‹' },
            { base: 'stop', past: 'stopped', meaning: 'æ­¢ã¾ã‚‹' },
            { base: 'go', past: 'went', meaning: 'è¡Œã' },
            { base: 'see', past: 'saw', meaning: 'è¦‹ã‚‹ãƒ»ä¼šã†' },
            { base: 'eat', past: 'ate', meaning: 'é£Ÿã¹ã‚‹' },
            { base: 'have', past: 'had', meaning: 'æŒã¤' },
            { base: 'buy', past: 'bought', meaning: 'è²·ã†' },
            { base: 'make', past: 'made', meaning: 'ä½œã‚‹' },
            { base: 'come', past: 'came', meaning: 'æ¥ã‚‹' },
            { base: 'write', past: 'wrote', meaning: 'æ›¸ã' },
            { base: 'read', past: 'read', meaning: 'èª­ã‚€' },
            { base: 'run', past: 'ran', meaning: 'èµ°ã‚‹' },
            { base: 'swim', past: 'swam', meaning: 'æ³³ã' },
            { base: 'know', past: 'knew', meaning: 'çŸ¥ã£ã¦ã„ã‚‹' },
            { base: 'say', past: 'said', meaning: 'è¨€ã†' }
        ];

        // ã‚²ãƒ¼ãƒ çŠ¶æ…‹ç®¡ç†
        let gameState = {
            mode: 'choice',
            difficulty: 'normal',
            questions: [],
            currentQIndex: 0,
            score: 0,
            combo: 0,
            maxCombo: 0
        };

        // ç”»é¢åˆ‡ã‚Šæ›¿ãˆé–¢æ•°
        function switchScreen(screenId) {
            const screens = ['screen-start', 'screen-difficulty', 'screen-game', 'screen-feedback', 'screen-result'];
            screens.forEach(id => {
                const el = document.getElementById(id);
                if (id === screenId) {
                    el.classList.remove('hidden');
                } else {
                    el.classList.add('hidden');
                }
            });
        }

        function backToStart() {
            switchScreen('screen-start');
        }

        // 1. ãƒ¢ãƒ¼ãƒ‰é¸æŠ
        function selectMode(mode) {
            console.log("Mode selected:", mode); // ãƒ‡ãƒãƒƒã‚°ç”¨
            gameState.mode = mode;
            switchScreen('screen-difficulty');
        }

        // 2. ã‚²ãƒ¼ãƒ é–‹å§‹
        function startGame(difficulty) {
            console.log("Game started:", difficulty); // ãƒ‡ãƒãƒƒã‚°ç”¨
            gameState.difficulty = difficulty;
            gameState.score = 0;
            gameState.combo = 0;
            gameState.maxCombo = 0;
            gameState.currentQIndex = 0;
            
            // ãƒ©ãƒ³ãƒ€ãƒ ã«10å•é¸å‡º
            gameState.questions = [...verbsData].sort(() => Math.random() - 0.5).slice(0, 10);
            
            switchScreen('screen-game');
            showQuestion();
        }

        // å•é¡Œè¡¨ç¤º
        function showQuestion() {
            const q = gameState.questions[gameState.currentQIndex];
            
            let isWriting = false;
            if (gameState.mode === 'writing') isWriting = true;
            else if (gameState.mode === 'mix') isWriting = Math.random() < 0.5;

            // UIæ›´æ–°
            document.getElementById('verb-base').textContent = q.base;
            document.getElementById('verb-meaning').textContent = `ï¼ˆ${q.meaning}ï¼‰`;
            document.getElementById('q-difficulty').textContent = `${gameState.currentQIndex + 1}/10å•ç›®`;
            document.getElementById('score-display').textContent = gameState.score;
            
            const comboEl = document.getElementById('combo-display');
            comboEl.textContent = gameState.combo > 1 ? `${gameState.combo} COMBO! ğŸ”¥` : '';

            // å…¥åŠ›æ¬„ãƒªã‚»ãƒƒãƒˆ
            const input = document.getElementById('answer-input');
            input.value = '';

            const choicesDiv = document.getElementById('choices-container');
            const writingDiv = document.getElementById('writing-container');

            if (isWriting) {
                choicesDiv.classList.add('hidden');
                writingDiv.classList.remove('hidden');
                setTimeout(() => input.focus(), 100);
            } else {
                writingDiv.classList.add('hidden');
                choicesDiv.classList.remove('hidden');
                generateChoices(q, gameState.difficulty);
            }
        }

        // é¸æŠè‚¢ç”Ÿæˆ
        function generateChoices(q, difficulty) {
            const container = document.getElementById('choices-container');
            container.innerHTML = '';

            let choices = [q.past];

            if (difficulty === 'easy') {
                const others = verbsData.filter(v => v.base !== q.base).map(v => v.past);
                choices.push(...others.sort(() => Math.random() - 0.5).slice(0, 3));
            } else {
                const distractors = generateTrickyDistractors(q);
                choices.push(...distractors.slice(0, 3));
            }

            choices.sort(() => Math.random() - 0.5);

            choices.forEach(choice => {
                const btn = document.createElement('button');
                btn.className = "choice-btn w-full py-4 bg-white/90 hover:bg-white text-indigo-900 text-xl font-bold rounded-xl shadow-lg border-b-4 border-indigo-200 active:border-b-0 active:translate-y-1";
                btn.textContent = choice;
                btn.onclick = () => checkAnswer(choice, false);
                container.appendChild(btn);
            });
        }

        // ã²ã£ã‹ã‘é¸æŠè‚¢ç”Ÿæˆ
        function generateTrickyDistractors(q) {
            let fakes = [];
            const base = q.base;
            
            fakes.push(base + 'ed');
            if (!base.endsWith('e')) fakes.push(base + 'd');
            if (base.endsWith('y')) fakes.push(base + 'ed');
            fakes.push(base + 'ing');
            
            if (base.match(/[aeiou][b-df-hj-np-tv-z]$/)) {
                fakes.push(base + 'ed'); 
            }

            const others = verbsData.filter(v => v.base !== base).map(v => v.past);
            fakes.push(...others);

            return [...new Set(fakes)].filter(f => f !== q.past).sort(() => Math.random() - 0.5);
        }

        // ç­”ãˆåˆã‚ã›
        function checkWritingAnswer() {
            const input = document.getElementById('answer-input');
            checkAnswer(input.value.trim().toLowerCase(), true);
        }

        function checkAnswer(userAnswer, isWritingInput) {
            const q = gameState.questions[gameState.currentQIndex];
            const isCorrect = (userAnswer === q.past);

            if (isCorrect) {
                gameState.combo++;
                if (gameState.combo > gameState.maxCombo) gameState.maxCombo = gameState.combo;

                let basePoint = 0;
                if (gameState.difficulty === 'easy') basePoint = 30;
                else if (gameState.difficulty === 'normal') basePoint = 40;
                else basePoint = 50;

                if (isWritingInput) basePoint += 20;

                let multiplier = 1.0;
                if (gameState.combo >= 8) multiplier = 2.5;
                else if (gameState.combo >= 5) multiplier = 2.0;
                else if (gameState.combo >= 3) multiplier = 1.5;

                const points = Math.floor(basePoint * multiplier);
                gameState.score += points;

                showFeedback(true, q.past, points, multiplier);
            } else {
                gameState.combo = 0;
                showFeedback(false, q.past, 0, 1);
            }
        }

        function showFeedback(isCorrect, correctAnswer, points, multiplier) {
            document.getElementById('screen-feedback').classList.remove('hidden');
            
            const icon = document.getElementById('fb-icon');
            const text = document.getElementById('fb-text');
            const detail = document.getElementById('fb-score-detail');
            const correctBox = document.getElementById('fb-correct-box');

            if (isCorrect) {
                icon.textContent = 'âš”ï¸';
                text.textContent = 'Nice!';
                text.className = "title-font text-4xl text-yellow-300 mb-2";
                
                let msg = `+${points} pts`;
                if (multiplier > 1) msg += ` (x${multiplier} Combo!)`;
                detail.textContent = msg;
                correctBox.classList.add('hidden');
            } else {
                icon.textContent = 'ğŸ’¥';
                text.textContent = 'Miss...';
                text.className = "title-font text-4xl text-rose-300 mb-2";
                detail.textContent = '';
                correctBox.classList.remove('hidden');
                document.getElementById('fb-correct-word').textContent = correctAnswer;
            }

            setTimeout(() => {
                const btn = document.getElementById('next-btn');
                btn.focus();
            }, 50);
        }

        function nextQuestion() {
            document.getElementById('screen-feedback').classList.add('hidden');
            gameState.currentQIndex++;

            if (gameState.currentQIndex >= 10) {
                endGame();
            } else {
                showQuestion();
            }
        }

        function endGame() {
            switchScreen('screen-result');
            document.getElementById('final-score').textContent = gameState.score;
            document.getElementById('final-combo').textContent = `æœ€å¤§ã‚³ãƒ³ãƒœ: ${gameState.maxCombo}`;
            loadRanking();
        }

        // ãƒ©ãƒ³ã‚­ãƒ³ã‚°ç³»
        const STORAGE_KEY = 'past_tense_ranking';

        function loadRanking() {
            const list = document.getElementById('ranking-list');
            const data = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
            
            data.sort((a, b) => b.score - a.score);

            if (data.length === 0) {
                list.innerHTML = '<p class="text-white/50 text-center">ã¾ã è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“</p>';
                return;
            }

            list.innerHTML = data.slice(0, 5).map((r, i) => {
                const medal = ['ğŸ¥‡','ğŸ¥ˆ','ğŸ¥‰'][i] || `${i+1}ä½`;
                return `
                    <div class="flex justify-between bg-white/10 p-2 rounded mb-1 items-center">
                        <span class="truncate max-w-[150px]">${medal} ${r.name}</span>
                        <span class="font-bold text-yellow-300">${r.score}</span>
                    </div>
                `;
            }).join('');
        }

        function saveScore() {
            const nameInput = document.getElementById('player-name');
            const name = nameInput.value.trim() || 'åç„¡ã—';
            
            const data = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
            data.push({
                name: name,
                score: gameState.score,
                date: new Date().toISOString()
            });
            
            localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
            alert('ã‚¹ã‚³ã‚¢ã‚’ä¿å­˜ã—ã¾ã—ãŸï¼');
            loadRanking();
            // é‡è¤‡ä¿å­˜é˜²æ­¢ã®ãŸã‚ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–ã™ã‚‹å‡¦ç†ã‚’å…¥ã‚Œã¦ã‚‚è‰¯ã„ã§ã™ãŒã€ä»Šå›ã¯ã‚·ãƒ³ãƒ—ãƒ«ã«
        }

        function showRanking() {
            switchScreen('screen-result');
            // çµæœç”»é¢ã®ã‚¹ã‚³ã‚¢è¡¨ç¤ºã‚’éš ã™ã€ã¾ãŸã¯ã€Œãƒ©ãƒ³ã‚­ãƒ³ã‚°é–²è¦§ãƒ¢ãƒ¼ãƒ‰ã€ã¨ã—ã¦æ‰±ã†
            document.getElementById('final-score').textContent = '-';
            document.getElementById('final-combo').textContent = '';
            loadRanking();
        }

        function shareResult() {
            const text = `è‹±èªéå»å½¢ã‚¯ã‚¨ã‚¹ãƒˆã§ ${gameState.score}ç‚¹ ã‚’ã¨ã£ãŸã‚ˆï¼\nãƒ¢ãƒ¼ãƒ‰: ${gameState.mode} / é›£æ˜“åº¦: ${gameState.difficulty}\n#è‹±èªå­¦ç¿’`;
            navigator.clipboard.writeText(text).then(() => {
                alert('çµæœã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼å‹é”ã«é€ã‚ã†ï¼');
            }).catch(err => {
                alert('ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
            });
        }

        // ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰æ“ä½œ
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                if (!document.getElementById('screen-feedback').classList.contains('hidden')) {
                    nextQuestion();
                    return;
                }
                if (!document.getElementById('screen-game').classList.contains('hidden') && 
                    !document.getElementById('writing-container').classList.contains('hidden')) {
                    checkWritingAnswer();
                }
            }
        });
    </script>
</body>
</html>
